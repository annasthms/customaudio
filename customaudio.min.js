/**********************************************

customaudio.js by annasthms
built: august 9, 2020
docs: https://annasthms.tumblr.com/more/js/customaudio

DO NOT STEAL
PLEASE CREDIT IF YOU USE

**********************************************/

class CustomAudio{settings={post:".post",wrappers:{audio:".custom_audio_wrapper",buttons:".custom_audio_buttons",duration:".custom_audio_duration",timeCurrent:".custom_audio_current_time",timeLeft:".custom_audio_time_left",seekbar:".custom_audio_seekbar"},default:!1,pauseAll:!0,playButton:"<i data-feather='play'></i>",pauseButton:"<i data-feather='pause'></i>",errorIcon:"<i data-feather='x'></i>",hideInfoIfError:!0,callAfterLoad:()=>{feather.replace()}};data=[];update_settings(options){for(const key in options)if(options.hasOwnProperty(key)&&this.settings.hasOwnProperty(key)){const element=options[key];"object"==typeof element?Object.assign(this.settings[key],element):this.settings[key]=element}}constructor(options={}){this.update_settings(options)}update(options={}){this.update_settings(options)}create_dom_element(type="div",attributes={},html=""){let temp=document.createElement(type);if(null!=attributes)for(let a in attributes)temp.setAttribute(a,attributes[a]);return""!=html&&(temp.innerHTML=html),temp}get_source(src){let audioSrc=decodeURIComponent(src).split("audio_file=")[1].split("&color=")[0];if(!audioSrc.includes(".mp3")){let tempSrc=audioSrc.split("/")[audioSrc.split("/").length-1];audioSrc="https://a.tumblr.com/"+tempSrc+"o1.mp3"}return audioSrc}update_time_data(data){const audio=data.audio;data.duration=audio.duration,data.current=audio.currentTime,data.remaining=audio.duration-audio.currentTime}format_time_text(time){if(NaN==time)return"N/A";const sec=(time=Math.ceil(time))%60,min=(time=Math.floor(time/60))%60;let text="";return text+=(min>9?min.toString():"0"+min.toString())+":",text+=sec>9?sec.toString():"0"+sec.toString(),text}update_time_text(data){data.wrappers.duration&&(data.wrappers.duration.innerText=this.format_time_text(data.duration)),data.wrappers.current&&(data.wrappers.current.innerText=this.format_time_text(data.current)),data.wrappers.remaining&&(data.wrappers.remaining.innerText=this.format_time_text(data.remaining))}getPosition(el){return el.getBoundingClientRect().left}clickPercent(event,b){return(event.clientX-this.getPosition(b))/parseFloat(getComputedStyle(b).getPropertyValue("width"))}update_seekbar(data){const audio=data.audio;data.wrappers.seekbar.querySelector(".custom_audio_seekbar_progress").style.width=(audio.currentTime/audio.duration*100).toString()+"%"}create_seekbar(data){const progress=this.create_dom_element("div",{class:"custom_audio_seekbar_progress"});data.wrappers.seekbar.appendChild(progress);const audio=data.audio;data.wrappers.seekbar.onclick=e=>{audio.currentTime=audio.duration*this.clickPercent(e,data.wrappers.seekbar),this.update_time_data(data),this.update_time_text(data),this.update_seekbar(data)}}pause_audio(data,post){data.audio.pause(),data.buttons.play.style.display="block",data.buttons.pause.style.display="none",post.classList.add("audio_paused"),post.classList.remove("audio_playing"),clearInterval(data.interval),this.update_time_data(data),this.update_time_text(data),this.update_seekbar(data)}pause_all(){this.data.forEach(d=>{this.pause_audio(d,d.post)})}customize_iframe(frame,post){const data={};data.iframe=frame.cloneNode(!0),data.post=post,data.playable=!1,data.playing=!1,data.wrappers={},data.buttons={},frame.style.display="none";const src=this.get_source(frame.src),sourceElem=this.create_dom_element("source",{src:src}),audioElem=this.create_dom_element("audio");if(audioElem.appendChild(sourceElem),data.audio=audioElem,null!=post.querySelector(this.settings.wrappers.audio+":not(.filled_audio)")){const audioWrapper=post.querySelector(this.settings.wrappers.audio+":not(.filled_audio)");audioWrapper.appendChild(audioElem),audioWrapper.classList.add("filled_audio")}else frame.insertAdjacentElement("afterend",audioElem);if(frame.parentElement.removeChild(frame),this.settings.default)return audioElem.setAttribute("controls","controls"),data.default=!0,data;if(data.default=!1,data.duration=NaN,data.current=NaN,data.remaining=NaN,data.playable=!1,this.settings.wrappers.duration&&post.querySelector(this.settings.wrappers.duration+":not(.filled_audio)")){const durationWrapper=post.querySelector(this.settings.wrappers.duration+":not(.filled_audio)");data.wrappers.duration=durationWrapper,durationWrapper.classList.add("filled_audio")}if(this.settings.wrappers.timeCurrent&&post.querySelector(this.settings.wrappers.timeCurrent+":not(.filled_audio)")){const currentWrapper=post.querySelector(this.settings.wrappers.timeCurrent+":not(.filled_audio)");data.wrappers.current=currentWrapper,currentWrapper.classList.add("filled_audio")}if(this.settings.wrappers.timeLeft&&post.querySelector(this.settings.wrappers.timeLeft+":not(.filled_audio)")){const remainingWrapper=post.querySelector(this.settings.wrappers.timeLeft+":not(.filled_audio)");data.wrappers.remaining=remainingWrapper,remainingWrapper.classList.add("filled_audio")}if(this.settings.hideInfoIfError||this.update_time_text(data),this.settings.wrappers.seekbar&&post.querySelector(this.settings.wrappers.seekbar+":not(.filled_audio)")){const seekbarWrapper=post.querySelector(this.settings.wrappers.seekbar+":not(.filled_audio)");data.wrappers.seekbar=seekbarWrapper,seekbarWrapper.classList.add("filled_audio")}if(data.wrappers.seekbar&&this.create_seekbar(data),this.settings.wrappers.buttons&&post.querySelector(this.settings.wrappers.buttons+":not(.filled_audio)")){const buttonsWrapper=post.querySelector(this.settings.wrappers.buttons+":not(.filled_audio)");data.wrappers.buttons=buttonsWrapper,buttonsWrapper.classList.add("filled_audio"),data.buttons.play=this.create_dom_element("div",{class:"custom_audio_play_button"},this.settings.playButton),data.buttons.pause=this.create_dom_element("div",{class:"custom_audio_pause_button"},this.settings.pauseButton),data.buttons.error=this.create_dom_element("div",{class:"custom_audio_error_icon"},this.settings.errorIcon),buttonsWrapper.classList.add("audio_error"),buttonsWrapper.appendChild(data.buttons.error)}return audioElem.onerror=()=>{3==audio.networkState&&"function"==typeof this.settings.callAfterLoad&&this.settings.callAfterLoad()},audioElem.onloadedmetadata=()=>{data.buttons.error.parentElement.removeChild(data.buttons.error),data.wrappers.buttons.appendChild(data.buttons.play),data.buttons.pause.style.display="none",data.wrappers.buttons.appendChild(data.buttons.pause),post.classList.add("audio_paused"),this.update_time_data(data),this.update_time_text(data),this.update_seekbar(data),data.playable=!0,"function"==typeof this.settings.callAfterLoad&&this.settings.callAfterLoad()},data.buttons.play.onclick=()=>{this.settings.pauseAll&&this.pause_all(),audioElem.play(),data.buttons.play.style.display="none",data.buttons.pause.style.display="block",post.classList.remove("audio_paused"),post.classList.add("audio_playing"),data.interval=setInterval(()=>{audioElem.paused&&this.pause_audio(data,post),this.update_time_data(data),this.update_time_text(data),this.update_seekbar(data)},500)},data.buttons.pause.onclick=()=>{this.pause_audio(data,post)},data}create(){const postSelector=this.settings.post,audioPosts=(Array.isArray(postSelector)?postSelector:"string"==typeof postSelector?Array.from(document.querySelectorAll(postSelector)):[]).filter(post=>null!=post.querySelector("iframe.tumblr_audio_player"));audioPosts.map(post=>post.querySelectorAll("iframe.tumblr_audio_player")).forEach((frames,i)=>{const post=audioPosts[i];frames.forEach(frame=>{this.data.push(this.customize_iframe(frame,post))})})}}function customAudio(options){new CustomAudio(options).create()}
